<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Данные по дате – 16 таблиц</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f4f6fa 0%, #e0e6f0 100%);
      margin: 0;
      padding: 20px;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 1200px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      width: 100%;
      flex-wrap: wrap;
      gap: 15px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo img {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .logo h1 {
      font-size: 1.5rem;
      color: #2c3e50;
      font-weight: 600;
    }

    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    #date-picker {
      padding: 10px 15px;
      font-size: 1rem;
      font-family: 'Arial Black', 'Impact', sans-serif;
      border: 2px solid #dc143c;
      border-radius: 10px;
      background-color: white;
      color: #1a2f40;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    #date-picker:hover {
      background-color: #f8f9fa;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    #rotate-toggle {
      padding: 10px 15px;
      background: linear-gradient(to bottom, #2c3e50, #1a2f40);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #rotate-toggle:hover {
      background: linear-gradient(to bottom, #dc143c, #b01030);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      width: 100%;
      flex-wrap: wrap;
      gap: 15px;
    }

    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      flex: 1;
      min-width: 200px;
      text-align: center;
    }

    .stat-card h3 {
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .stat-card p {
      font-size: 1.5rem;
      font-weight: bold;
      color: #dc143c;
    }

    .table-wrapper {
      overflow-x: auto;
      overflow-y: visible;
      position: relative;
      -webkit-overflow-scrolling: touch;
      max-width: 100%;
      margin: 0 auto;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      background: white;
      padding: 10px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: auto;
      background-color: white;
      border-radius: 12px;
      min-width: 800px;
    }

    td, th {
      height: 30px;
      text-align: center;
      font-size: 13px;
      border: 1px solid #d7dce3;
      box-sizing: border-box;
      white-space: nowrap;
      vertical-align: middle;
      position: relative;
      transition: background-color 0.2s ease;
    }

    th {
      background-color: #ecf0f1;
      color: #1a2f40;
      font-weight: 600;
    }

    /* Фиксированные первые два столбца */
    #main-table th:nth-child(1),
    #main-table td:nth-child(1),
    #main-table th:nth-child(2),
    #main-table td:nth-child(2) {
      position: sticky;
    }
    
    #main-table th:nth-child(1),
    #main-table td:nth-child(1) {
      left: 0;
      z-index: 3;
      background-color: #dc143c;
      color: white;
      width: 50px;
      min-width: 50px;
      max-width: 50px;
    }
    
    #main-table th:nth-child(2),
    #main-table td:nth-child(2) {
      left: 50px;
      z-index: 5;
      background-color: #2c3e50;
      color: white;
      width: 120px;
      min-width: 120px;
      max-width: 120px;
      overflow: hidden;
    }

    /* Заголовки первой и второй строки */
    #letter-row th:nth-child(1),
    #letter-row th:nth-child(2),
    #time-row th:nth-child(1),
    #time-row th:nth-child(2) {
      background-color: #ecf0f1 !important;
      color: #2c3e50 !important;
      border: 0px solid #d7dce3 !important;
      z-index: 4;
    }

    #letter-row th:nth-child(n+3) {
      background-color: #ecf0f1 !important;
      color: #2c3e50;
      border: 1px solid #e0e0e0 !important;
    }
    
    #time-row th:nth-child(n+3) {
      white-space: normal;
      padding: 4px 2px;
      line-height: 1;
      vertical-align: middle;
      border: 1px solid #e0e0e0;
      width: auto;
    }
    
    #time-row th div {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    #time-row th .hour {
      font-size: 12px;
      font-weight: bold;
    }
    
    #time-row th .minute {
      font-size: 12px;
    }

    .hidden-column {
      display: none !important;
    }
    
    .active-cell {
      background-color: #2c3e50;
      color: #fff;
      font-weight: 700;
    }
    
    td.hover-row, th.hover-row,
    td.hover-col, th.hover-col {
      background-color: #fa849c !important;
    }

    .status-message {
      text-align: center;
      padding: 15px;
      margin: 15px 0;
      border-radius: 10px;
      background-color: #f8f9fa;
      font-size: 16px;
      width: 100%;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .error {
      background-color: #ffebee !important;
      color: #c62828 !important;
      border: 1px solid #ffcdd2;
    }

    .success {
      background-color: #e8f5e9 !important;
      color: #2e7d32 !important;
      border: 1px solid #c8e6c9;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .footer {
      margin-top: 30px;
      text-align: center;
      color: #7f8c8d;
      font-size: 0.9rem;
      width: 100%;
      padding: 15px;
    }

    /* Стили для мобильных устройств */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }
      
      .header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .logo {
        justify-content: center;
      }
      
      .controls {
        justify-content: center;
      }
      
      .stats {
        flex-direction: column;
      }
      
      .table-wrapper {
        overflow-x: scroll;
      }
      
      table {
        min-width: 100%;
      }
      
      #main-table th:nth-child(1),
      #main-table td:nth-child(1) {
        width: 40px;
        min-width: 40px;
        max-width: 40px;
      }
      
      #main-table th:nth-child(2),
      #main-table td:nth-child(2) {
        left: 40px;
        width: 100px;
        min-width: 100px;
        max-width: 100px;
      }
      
      td, th {
        font-size: 12px;
        height: 25px;
      }
      
      #time-row th .hour, #time-row th .minute {
        font-size: 10px;
      }
      
      .toggle-btn {
        font-size: 12px;
        height: 25px;
        line-height: 22px;
      }
      
      /* Стили для ПОВЕРНУТОГО вида на мобильных */
      html.rotated {
        width: 100vh;
        height: 100vw;
        transform: rotate(90deg) translateY(-100vw);
        transform-origin: top left;
        position: absolute;
        top: 0;
        left: 100vw;
        overflow-x: hidden;
      }
      
      html.rotated body {
        width: 100vh;
        height: 100vw;
        padding: 20px;
      }
      
      /* Кнопка возврата из повернутого режима */
      #rotate-toggle {
        display: none;
      }
      
      html.rotated #rotate-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        background: linear-gradient(to bottom, #dc143c, #b01030);
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        align-items: center;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <img src="https://i.postimg.cc/SQ3RgNsQ/image.png" alt="Logo" />
        <h1>Боулинг клуб<br>Статистика дорожек</h1>
      </div>
      <div class="controls">
        <input type="date" id="date-picker" />
        <button id="rotate-toggle">↻ Повернуть</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <h3>Общее время</h3>
        <p id="overall-total">0ч 0м</p>
      </div>
      <div class="stat-card">
        <h3>Среднее на дорожку</h3>
        <p id="average-time">0ч 0м</p>
      </div>
      <div class="stat-card">
        <h3>Активных дорожек</h3>
        <p id="active-lanes">0</p>
      </div>
    </div>

    <div id="status" class="status-message">Выберите дату для загрузки данных</div>
    
    <div class="table-wrapper">
      <table id="main-table">
        <thead>
          <tr id="letter-row">
            <th class="logo-cell" id="logo-wrapper" style="cursor: pointer;">
              №
            </th>
            <th>
              Дорожка
            </th>
          </tr>
          <tr id="time-row">
            <th>LANE</th>
            <th id="overall-total-header">0ч 0м</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>

    <div class="footer">
      <p>© 2023 Боулинг клуб | Статистика в реальном времени</p>
    </div>
  </div>

  <script>
    // Имитация данных для демонстрации
    const generateMockData = (date) => {
      const results = [];
      for (let i = 0; i < 16; i++) {
        const activeTimes = [];
        const busyTimes = [];
        
        // Генерация случайных активных периодов
        for (let j = 0; j < 10; j++) {
          const hour = Math.floor(Math.random() * 24);
          const minute = Math.floor(Math.random() * 60);
          activeTimes.push(`${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`);
        }
        
        // Генерация случайных занятых периодов
        for (let j = 0; j < 5; j++) {
          const hour = Math.floor(Math.random() * 24);
          const minute = Math.floor(Math.random() * 60);
          busyTimes.push(`${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`);
        }
        
        results.push({
          a: `Дорожка ${i+1}`,
          b: busyTimes,
          c: activeTimes
        });
      }
      return Promise.resolve(results);
    };

    const totalMinutes = 1440; // 24 часа * 60 минут
    const groupInterval = 15;
    const groupSize = 14;
    
    const letterRow = document.getElementById('letter-row');
    const timeRow = document.getElementById('time-row');
    const overallTotal = document.getElementById('overall-total');
    const overallTotalHeader = document.getElementById('overall-total-header');
    const averageTime = document.getElementById('average-time');
    const activeLanes = document.getElementById('active-lanes');
    const tableBody = document.getElementById('table-body');
    const datePicker = document.getElementById('date-picker');
    const statusEl = document.getElementById('status');
    const rotateToggle = document.getElementById('rotate-toggle');
    
    const allGroups = [];
    const allDataCells = [];
    let isLoading = false;

    function formatMinutes(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${h}ч ${m}м`;
    }

    function toggleGroup(idxs) {
      idxs.forEach(i => {
        [timeRow, letterRow].forEach(row => {
          if (row.children[i+2]) row.children[i+2].classList.toggle('hidden-column');
        });
        tableBody.querySelectorAll('tr').forEach(tr => {
          if (tr.children[i+2]) tr.children[i+2].classList.toggle('hidden-column');
        });
      });
    }

    function areAllHidden() {
      return allGroups.every(g => {
        const el = timeRow.children[g[0]+2];
        return el && el.classList.contains('hidden-column');
      });
    }

    function toggleAll(forceHide = null) {
      const shouldHide = forceHide !== null ? forceHide : !areAllHidden();
      allGroups.forEach(g => {
        const el = timeRow.children[g[0]+2];
        if (el) {
          const hidden = el.classList.contains('hidden-column');
          if (hidden !== shouldHide) toggleGroup(g);
        }
      });
      document.querySelectorAll('.toggle-btn').forEach(b => b.textContent = shouldHide ? '+' : '–');
    }

    function makeBtn(idxs, title) {
      const btn = document.createElement('div');
      btn.className = 'toggle-btn';
      btn.title = title;
      btn.textContent = '+';
      let last = 0;
      btn.onclick = () => {
        const now = Date.now();
        if (now - last < 300) toggleAll(!areAllHidden());
        else {
          toggleGroup(idxs);
          btn.textContent = timeRow.children[idxs[0]+2].classList.contains('hidden-column') ? '+' : '–';
        }
        last = now;
      };
      return btn;
    }

    function buildHeaders() {
      const fragL = document.createDocumentFragment();
      const fragT = document.createDocumentFragment();
      
      for (let i = 1; i <= totalMinutes; i++) {
        const thL = document.createElement('th'); 
        fragL.appendChild(thL);
        
        const h = Math.floor((i - 1) / 60);
        const m = (i - 1) % 60;
        const thT = document.createElement('th');
        thT.innerHTML = `<div class="hour">${String(h).padStart(2,'0')}</div><div class="minute">${String(m).padStart(2,'0')}</div>`;
        fragT.appendChild(thT);
        
        if ((h*60 + m) % groupInterval === 0) {
          const start = (h*60 + m) === 0 ? 1 : (h*60 + m) + 1;
          const end = Math.min(start + groupSize - 1, totalMinutes - 1);
          const idxs = [];
          for (let j = start; j <= end; j++) idxs.push(j);
          if (idxs.length) {
            fragL.lastChild.appendChild(makeBtn(idxs, `Свернуть/развернуть ${formatMinutes(idxs[0])}–${formatMinutes(idxs[idxs.length-1])}`));
            allGroups.push(idxs);
          }
        }
      }
      
      letterRow.appendChild(fragL);
      timeRow.appendChild(fragT);
    }

    function buildBody() {
      const frag = document.createDocumentFragment();
      
      for (let lane = 0; lane < 16; lane++) {
        const tr = document.createElement('tr');
        
        const thLane = document.createElement('th'); 
        thLane.textContent = lane + 1; 
        tr.appendChild(thLane);
        
        const thCount = document.createElement('th'); 
        tr.appendChild(thCount);
        
        const cells = [];
        for (let i = 0; i < totalMinutes; i++) {
          const td = document.createElement('td');
          tr.appendChild(td);
          cells.push(td);
        }
        
        frag.appendChild(tr);
        allDataCells.push({ header: thCount, cells });
      }
      
      tableBody.appendChild(frag);
    }

    function clearRows() {
      overallTotal.textContent = '0ч 0м';
      overallTotalHeader.textContent = '0ч 0м';
      averageTime.textContent = '0ч 0м';
      activeLanes.textContent = '0';
      
      allDataCells.forEach(r => {
        r.header.textContent = '';
        r.cells.forEach(c => {
          c.classList.remove('active-cell');
          c.textContent = '';
          c.style.color = '';
        });
      });
    }

    function setStatus(message, isError = false) {
      statusEl.textContent = message;
      statusEl.className = isError ? 'status-message error' : 'status-message';
    }

    function updateStats(data) {
      let totalActive = 0;
      let lanesWithActivity = 0;
      
      data.forEach(laneData => {
        const activeCount = laneData.c ? laneData.c.length : 0;
        totalActive += activeCount;
        if (activeCount > 0) lanesWithActivity++;
      });
      
      overallTotal.textContent = formatMinutes(totalActive);
      overallTotalHeader.textContent = formatMinutes(totalActive);
      averageTime.textContent = formatMinutes(lanesWithActivity > 0 ? Math.round(totalActive / lanesWithActivity) : 0);
      activeLanes.textContent = lanesWithActivity;
    }

    async function loadData() {
      if (!datePicker.value || isLoading) return;
      
      isLoading = true;
      clearRows();
      setStatus('Загрузка данных...');
      
      const selectedDate = datePicker.value;
      
      try {
        // В реальном приложении здесь был бы fetch к API
        // const response = await fetch(`https://script.google.com/...?date=${selectedDate}`);
        // const data = await response.json();
        
        // Используем моковые данные для демонстрации
        const data = await generateMockData(selectedDate);
        
        updateStats(data);
        
        data.forEach((laneData, idx) => {
          const row = allDataCells[idx];
          let sum = 0;
          
          row.cells.forEach((cell, i) => {
            const hour = Math.floor(i / 60);
            const minute = i % 60;
            const time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            
            cell.classList.remove('active-cell');
            
            if (laneData.c && laneData.c.includes(time)) {
              cell.classList.add('active-cell');
              cell.textContent = '🎳';
              sum++;
            } else if (laneData.b && laneData.b.includes(time)) {
              cell.textContent = '⏸';
              cell.style.color = '#7f8c8d';
            } else {
              cell.textContent = '⚡';
              cell.style.color = '#dc143c';
            }
          });
          
          row.header.textContent = formatMinutes(sum);
        });
        
        setStatus(`Данные за ${selectedDate} успешно загружены.`, false);
      } catch (error) {
        console.error('Ошибка загрузки:', error);
        setStatus(`Ошибка загрузки: ${error.message}`, true);
      } finally {
        isLoading = false;
      }
    }

    function init() {
      // Установка текущей даты по умолчанию
      const today = new Date();
      const formattedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      datePicker.value = formattedDate;
      
      // Построение таблицы
      buildHeaders();
      buildBody();
      
      // Обработчики событий
      datePicker.addEventListener('change', loadData);
      
      document.addEventListener('mouseover', function(e) {
        if (e.target.tagName === 'TD') {
          const td = e.target;
          const ci = td.cellIndex;
          const row = td.parentElement;
          
          row.querySelectorAll('td').forEach(cell => cell.classList.add('hover-row'));
          
          document.querySelectorAll('#main-table tbody tr').forEach(r => {
            const c = r.children[ci];
            if (c) c.classList.add('hover-col');
          });
          
          const th = document.querySelector(`#letter-row th:nth-child(${ci+1})`);
          if (th) th.classList.add('hover-col');
        }
      });
      
      document.addEventListener('mouseout', function(e) {
        if (e.target.tagName === 'TD') {
          document.querySelectorAll('.hover-row, .hover-col').forEach(el => {
            el.classList.remove('hover-row', 'hover-col');
          });
        }
      });
      
      // Обработчик для кнопки поворота
      rotateToggle.addEventListener('click', function() {
        document.documentElement.classList.toggle('rotated');
        this.textContent = document.documentElement.classList.contains('rotated') ? '↩ Вернуть' : '↻ Повернуть';
      });
      
      // Сворачиваем все группы при загрузке
      setTimeout(() => toggleAll(true), 100);
      
      // Загружаем данные
      setTimeout(loadData, 500);
    }

    // Инициализация при загрузке страницы
    window.addEventListener('load', init);
  </script>
</body>
</html>