<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–î–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–µ ‚Äì 16 —Ç–∞–±–ª–∏—Ü</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6fa;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .table-wrapper {
      overflow-x: auto;
      overflow-y: visible;
      position: relative;
      -webkit-overflow-scrolling: touch;
      max-width: 100%;
      margin: 0 auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: auto;
      background-color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      min-width: 800px;
    }

    td, th {
      height: 30px;
      text-align: center;
      font-size: 13px;
      border: 1px solid #d7dce3;
      box-sizing: border-box;
      white-space: nowrap;
      vertical-align: middle;
      position: relative;
      transition: background-color 0.2s ease;
    }

    th {
      background-color: #ecf0f1;
      color: #1a2f40;
      font-weight: 600;
    }

    /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü (–≤—Ä–µ–º—è) –∏ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞ (–∏—Ç–æ–≥–∏) */
    #main-table th:nth-child(1),
    #main-table td:nth-child(1) {
      position: sticky;
      left: 0;
      z-index: 3;
      background-color: #dc143c;
      color: white;
      width: 50px;
      min-width: 50px;
      max-width: 50px;
    }
    
    #main-table tr:last-child th,
    #main-table tr:last-child td {
      position: sticky;
      bottom: 0;
      z-index: 2;
      background-color: #2c3e50;
      color: white;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ (–Ω–æ–º–µ—Ä–∞ –¥–æ—Ä–æ–∂–µ–∫) */
    #lane-row th {
      background-color: #ecf0f1 !important;
      color: #2c3e50 !important;
      border: 1px solid #d7dce3 !important;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ (–≤—Ä–µ–º—è) */
    #time-col th {
      white-space: normal;
      padding: 4px 2px;
      line-height: 1;
      vertical-align: middle;
      border: 1px solid #e0e0e0;
      width: auto;
    }
    #time-col th div {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #time-col th .hour {
      font-size: 12px;
      font-weight: bold;
    }
    #time-col th .minute {
      font-size: 12px;
    }

    .hidden-column {
      display: none !important;
    }
    .active-cell {
      background-color: #2c3e50;
      color: #fff;
      font-weight: 700;
    }
    td.hover-row, th.hover-row,
    td.hover-col, th.hover-col {
      background-color: #fa849c !important;
    }

    #date-picker {
      width: 100%;
      padding: 8px;
      font-size: 13px;
      font-family: 'Arial Black','Impact', sans-serif;
      border: 1px solid #ecf0f1;
      border-radius: 10px;
      background-color: #ecf0f1;
      color: #1a2f40;
      box-sizing: border-box;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      outline: none;
    }
    #date-picker:hover {
      background-color: #e0e0e0;
    }
    #date-picker::-webkit-calendar-picker-indicator {
      filter: invert(0.3);
      cursor: pointer;
    }

    /* –ö–Ω–æ–ø–∫–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ */
    .toggle-btn {
      cursor: pointer;
      user-select: none;
      color: #fff;
      background-color: #1a2f40;
      border-radius: 4px;
      font-weight: bold;
      font-size: 14px;
      line-height: 27px;
      padding: 0 6px;
      display: inline-block;
      width: 10px;
      height: 30px;
      text-align: center;
      transition: background-color 0.1s ease;
    }
    .toggle-btn:hover {
      background-color: #dc143c;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status-message {
      text-align: center;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      background-color: #f8f9fa;
      font-size: 14px;
    }

    .error {
      background-color: #ffebee !important;
      color: #c62828 !important;
    }

    .success {
      color: #2e7d32;
    }

    @media (max-width: 768px) {
      body { padding: 10px; }
      .table-wrapper { overflow-x: scroll; }
      table { min-width: 100%; }
      #main-table th:nth-child(1),
      #main-table td:nth-child(1) { width: 40px; min-width: 40px; max-width: 40px; }
      td, th { font-size: 12px; height: 25px; }
      #time-col th .hour, #time-col th .minute { font-size: 10px; }
      .toggle-btn { font-size: 12px; height: 25px; line-height: 22px; }
    }
  </style>
</head>
<body>
  <div id="status" class="status-message">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>
  
  <div class="table-wrapper">
    <table id="main-table">
      <thead>
        <tr id="lane-row">
          <th class="logo-cell" id="logo-wrapper" style="cursor: pointer;">
            <img src="https://i.postimg.cc/SQ3RgNsQ/image.png" alt="Logo" style="width:45px;height:45px;border-radius:0;" />
          </th>
          <!-- –ù–æ–º–µ—Ä–∞ –¥–æ—Ä–æ–∂–µ–∫ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
        </tr>
        <tr id="total-row">
          <th>
            <input type="date" id="date-picker" />
          </th>
          <!-- –ò—Ç–æ–≥–∏ –ø–æ –¥–æ—Ä–æ–∂–∫–∞–º –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
        </tr>
      </thead>
      <tbody id="table-body">
        <!-- –í—Ä–µ–º—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –∑–¥–µ—Å—å -->
      </tbody>
      <tfoot>
        <tr id="overall-row">
          <th id="overall-total">0—á 0–º</th>
          <!-- –û–±—â–∏–π –∏—Ç–æ–≥ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∑–¥–µ—Å—å -->
        </tr>
      </tfoot>
    </table>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJcg8Ov4_-ijxTLQxJDjm2-IKCmI8l0AAsDo4sMeU-avSQp3F_E54gyB7f26z_KaE0FA/exec';
    const totalMinutes = 1440, groupInterval = 15, groupSize = 14;
    const laneRow = document.getElementById('lane-row'),
          totalRow = document.getElementById('total-row'),
          overallRow = document.getElementById('overall-row'),
          overallTotal = document.getElementById('overall-total'),
          tableBody = document.getElementById('table-body'),
          datePicker = document.getElementById('date-picker'),
          statusEl = document.getElementById('status');
    const allGroups = [], allDataCells = [];
    let isLoading = false;
    const fetchControllers = new Map();

    function formatMinutes(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${h}—á ${m}–º`;
    }

    function toggleGroup(idxs) {
      idxs.forEach(i => {
        // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–æ–ª–±—Ü—ã —Å –¥–∞–Ω–Ω—ã–º–∏
        laneRow.children[i+1].classList.toggle('hidden-column');
        totalRow.children[i+1].classList.toggle('hidden-column');
        overallRow.children[i+1].classList.toggle('hidden-column');
        tableBody.querySelectorAll('tr').forEach(tr => {
          if (tr.children[i+1]) tr.children[i+1].classList.toggle('hidden-column');
        });
      });
    }

    function areAllHidden() {
      return allGroups.every(g => {
        const el = laneRow.children[g[0]+1];
        return el && el.classList.contains('hidden-column');
      });
    }

    function toggleAll(forceHide=null) {
      const shouldHide = forceHide !== null ? forceHide : !areAllHidden();
      allGroups.forEach(g => {
        const el = laneRow.children[g[0]+1];
        if (el) {
          const hidden = el.classList.contains('hidden-column');
          if (hidden !== shouldHide) toggleGroup(g);
        }
      });
      document.querySelectorAll('.toggle-btn').forEach(b => b.textContent = shouldHide ? '+' : '‚Äì');
    }

    function makeBtn(idxs, title) {
      const btn = document.createElement('div');
      btn.className = 'toggle-btn';
      btn.title = title;
      btn.textContent = '+';
      let last = 0;
      btn.onclick = () => {
        const now = Date.now();
        if (now - last < 300) toggleAll(!areAllHidden());
        else {
          toggleGroup(idxs);
          btn.textContent = laneRow.children[idxs[0]+1].classList.contains('hidden-column') ? '+' : '‚Äì';
        }
        last = now;
      };
      return btn;
    }

    function buildHeaders() {
      // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –¥–æ—Ä–æ–∂–µ–∫
      const fragLane = document.createDocumentFragment();
      const fragTotal = document.createDocumentFragment();
      const fragOverall = document.createDocumentFragment();
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è 16 –¥–æ—Ä–æ–∂–µ–∫
      for (let lane = 1; lane <= 16; lane++) {
        const thLane = document.createElement('th');
        thLane.textContent = lane;
        fragLane.appendChild(thLane);
        
        const thTotal = document.createElement('th');
        thTotal.textContent = '0—á 0–º';
        fragTotal.appendChild(thTotal);
        
        const thOverall = document.createElement('th');
        thOverall.textContent = '';
        fragOverall.appendChild(thOverall);
      }
      
      laneRow.appendChild(fragLane);
      totalRow.appendChild(fragTotal);
      overallRow.appendChild(fragOverall);
    }

    function buildTimeColumn() {
      // –°–æ–∑–¥–∞–µ–º –∫–æ–ª–æ–Ω–∫—É —Å –≤—Ä–µ–º–µ–Ω–µ–º
      for (let i = 1; i <= totalMinutes; i++) {
        const tr = document.createElement('tr');
        const h = Math.floor((i - 1) / 60), m = (i - 1) % 60;
        
        // –Ø—á–µ–π–∫–∞ —Å –≤—Ä–µ–º–µ–Ω–µ–º
        const thTime = document.createElement('th');
        thTime.innerHTML = `<div class="hour">${String(h).padStart(2,'0')}</div><div class="minute">${String(m).padStart(2,'0')}</div>`;
        tr.appendChild(thTime);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
        if ((h*60 + m) % groupInterval === 0) {
          const start = (h*60 + m) === 0 ? 1 : (h*60 + m) + 1;
          const end = Math.min(start + groupSize - 1, totalMinutes - 1);
          const idxs = [];
          for (let j = start; j <= end; j++) idxs.push(j);
          if (idxs.length) {
            thTime.appendChild(makeBtn(idxs, `–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å ${formatMinutes(idxs[0])}‚Äì${formatMinutes(idxs[idxs.length-1])}`));
            allGroups.push(idxs);
          }
        }
        
        // –Ø—á–µ–π–∫–∏ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
        const cells = [];
        for (let lane = 0; lane < 16; lane++) {
          const td = document.createElement('td');
          tr.appendChild(td);
          cells.push(td);
        }
        
        tableBody.appendChild(tr);
        allDataCells.push({ timeCell: thTime, cells });
      }
    }

    function clearRows() {
      fetchControllers.forEach(controller => controller.abort());
      fetchControllers.clear();
      overallTotal.textContent = '0—á 0–º';
      
      // –û—á–∏—â–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–æ—Ä–æ–∂–µ–∫
      for (let i = 1; i < totalRow.children.length; i++) {
        totalRow.children[i].textContent = '0—á 0–º';
      }
      
      // –û—á–∏—â–∞–µ–º —è—á–µ–π–∫–∏ –¥–∞–Ω–Ω—ã—Ö
      allDataCells.forEach(row => {
        row.cells.forEach(cell => {
          cell.classList.remove('active-cell');
          cell.textContent = '';
          cell.style.color = '';
        });
      });
    }

    function setStatus(message, isError = false) {
      statusEl.textContent = message;
      if (isError) statusEl.classList.add('error'); else statusEl.classList.remove('error');
    }

    async function loadLaneData(idx, selectedDate) {
      const controller = new AbortController();
      fetchControllers.set(idx, controller);
      try {
        const url = `${SCRIPT_URL}?action=getData&index=${idx}&date=${selectedDate}&t=${Date.now()}`;
        const response = await fetch(url, { signal: controller.signal });
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        return data;
      } finally { fetchControllers.delete(idx); }
    }

    async function loadData() {
      if (!datePicker.value || isLoading) return;
      isLoading = true;
      clearRows();
      setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
      const selectedDate = datePicker.value;
      let done = 0, sumAll = 0;
      const errors = [];
      const promises = [];
      try {
        for (let idx = 0; idx < 16; idx++) {
          promises.push(
            loadLaneData(idx, selectedDate)
              .then(data => {
                let sum = 0;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–π –º–∏–Ω—É—Ç—ã
                allDataCells.forEach((row, i) => {
                  const time = `${String(Math.floor(i/60)).padStart(2,'0')}:${String(i%60).padStart(2,'0')}`;
                  const cell = row.cells[idx];
                  cell.classList.remove('active-cell');
                  
                  if (data.c && data.c.includes(time)) { 
                    cell.classList.add('active-cell'); 
                    cell.textContent = 'üé≥'; 
                    sum++; 
                  }
                  else if (data.b && data.b.includes(time)) { 
                    cell.textContent = ''; 
                    cell.style.color = 'black'; 
                  }
                  else { 
                    cell.textContent = '‚ö°Ô∏é'; 
                    cell.style.color = '#dc143c'; 
                  }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥ –¥–ª—è –¥–æ—Ä–æ–∂–∫–∏
                totalRow.children[idx+1].textContent = formatMinutes(sum);
                sumAll += sum;
                done++;
                setStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${done} –∏–∑ 16 –¥–æ—Ä–æ–∂–µ–∫...`);
              })
              .catch(err => { 
                console.error(`–û—à–∏–±–∫–∞ –¥–æ—Ä–æ–∂–∫–∏ ${idx+1}:`, err); 
                errors.push(`–î–æ—Ä–æ–∂–∫–∞ ${idx+1}: ${err.message}`); 
                done++; 
              })
          );
        }
        await Promise.allSettled(promises);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π –∏—Ç–æ–≥
        overallTotal.textContent = formatMinutes(sumAll);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –≤ —Å—Ç—Ä–æ–∫–µ overallRow
        for (let i = 1; i < overallRow.children.length; i++) {
          overallRow.children[i].textContent = formatMinutes(sumAll);
        }
        
        if (errors.length > 0) setStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –æ—à–∏–±–∫–∞–º–∏: ${errors.join('; ')}`, true);
        else setStatus(`–î–∞–Ω–Ω—ã–µ –∑–∞ ${selectedDate} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –í—Å–µ–≥–æ: ${formatMinutes(sumAll)}`);
      } catch (error) { 
        console.error('–û–±—â–∞—è –æ—à–∏–±–∫–∞:', error); 
        setStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, true); 
      }
      finally { isLoading = false; }
    }

    function init() {
      buildHeaders();
      buildTimeColumn();
      datePicker.addEventListener('change', loadData);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å—Ç—Ä–æ–∫ –∏ —Å—Ç–æ–ª–±—Ü–æ–≤
      document.addEventListener('mouseover', function(e) {
        if (e.target.tagName === 'TD' || e.target.tagName === 'TH') {
          const cell = e.target;
          const ci = cell.cellIndex;
          const row = cell.parentElement;
          
          // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏
          if (row.parentElement === tableBody) {
            row.querySelectorAll('td, th').forEach(c => c.classList.add('hover-row'));
          }
          
          // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç–æ–ª–±—Ü–∞
          if (ci > 0) { // –ò—Å–∫–ª—é—á–∞–µ–º –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü (–≤—Ä–µ–º—è)
            document.querySelectorAll('#main-table tbody tr').forEach(r => { 
              const c = r.children[ci]; 
              if (c) c.classList.add('hover-col'); 
            });
            const th = document.querySelector(`#lane-row th:nth-child(${ci+1})`);
            if (th) th.classList.add('hover-col');
          }
        }
      });
      
      document.addEventListener('mouseout', function(e) {
        if (e.target.tagName === 'TD' || e.target.tagName === 'TH') {
          document.querySelectorAll('.hover-row, .hover-col').forEach(el => 
            el.classList.remove('hover-row', 'hover-col'));
        }
      });
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
      const t = new Date();
      const iso = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
      datePicker.value = iso;
      
      // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å–µ –≥—Ä—É–ø–ø—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      setTimeout(() => toggleAll(true), 100);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –ª–æ–≥–æ—Ç–∏–ø—É
      document.getElementById('logo-wrapper').addEventListener('click', () => { datePicker.click(); });
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      setTimeout(loadData, 500);
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>