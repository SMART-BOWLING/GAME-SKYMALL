<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–î–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–µ ‚Äì 16 –¥–æ—Ä–æ–∂–µ–∫</title>
<style>
* { box-sizing: border-box; margin:0; padding:0; }
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f4f6fa; color:#333;
  overflow:hidden; width:100vw; height:100vh; position:fixed;
}
.rotated-container {
  transform: rotate(90deg); transform-origin: center center;
  width:100vh; height:100vw; position:absolute;
  top:50%; left:50%; margin-top:-50vw; margin-left:-50vh;
  overflow:auto; padding:10px;
}
.mobile-optimized-table { display:flex; flex-direction:column; height:100%; }
.status-message {
  text-align:center; padding:8px; margin:8px 0; border-radius:5px;
  background-color:#f8f9fa; font-size:14px;
}
.table-container {
  flex:1; overflow:auto; border:1px solid #d7dce3;
  border-radius:12px; background:white; box-shadow:0 4px 12px rgba(0,0,0,0.05);
}
table { border-collapse:collapse; width:auto; table-layout:fixed; background:white; }
td, th {
  height:30px; text-align:center; font-size:12px;
  border:1px solid #d7dce3; white-space:nowrap; vertical-align:middle;
  position:relative; transition: background-color 0.2s ease; padding:2px;
}
th { background-color:#ecf0f1; color:#1a2f40; font-weight:600; }
#main-table th:nth-child(1), #main-table td:nth-child(1) {
  position:sticky; left:0; z-index:3; background-color:#dc143c; color:white; width:40px; min-width:40px;
}
#main-table th:nth-child(2), #main-table td:nth-child(2) {
  position:sticky; left:40px; z-index:5; background-color:#2c3e50; color:white; width:90px; min-width:90px;
}
#letter-row th:nth-child(1), #letter-row th:nth-child(2),
#time-row th:nth-child(1), #time-row th:nth-child(2) {
  background-color:#ecf0f1!important; color:#2c3e50!important; border:0!important; z-index:4;
}
#letter-row th:nth-child(n+3), #time-row th:nth-child(n+3) { width:30px; min-width:30px; }
#time-row th div { display:flex; flex-direction:column; align-items:center; }
#time-row th .hour, #time-row th .minute { font-size:10px; font-weight:bold; }
#table-body td:nth-child(n+3) { width:30px; min-width:30px; }
.hidden-column { display:none!important; }
.active-cell { background-color:#2c3e50; color:#fff; font-weight:700; }
td.hover-row, th.hover-row, td.hover-col, th.hover-col { background-color:#fa849c!important; }
#date-picker {
  width:100%; padding:6px; font-size:12px; font-family:'Arial Black','Impact',sans-serif;
  border:1px solid #ecf0f1; border-radius:8px; background-color:#ecf0f1; color:#1a2f40;
  cursor:pointer; -webkit-appearance:none; appearance:none; outline:none;
}
#date-picker:hover { background-color:#e0e0e0; }
#date-picker::-webkit-calendar-picker-indicator { filter:invert(0.3); cursor:pointer; }
.toggle-btn {
  cursor:pointer; user-select:none; color:#fff; background-color:#1a2f40;
  border-radius:3px; font-weight:bold; font-size:12px; line-height:20px; padding:0 4px;
  display:inline-block; width:8px; height:20px; text-align:center; transition:0.1s;
}
.toggle-btn:hover { background-color:#dc143c; }
.error { background-color:#ffebee!important; color:#c62828!important; }
.success { color:#2e7d32; }
</style>
</head>
<body>
<div class="rotated-container">
  <div class="mobile-optimized-table">
    <div id="status" class="status-message">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>
    <div class="table-container">
      <table id="main-table">
        <thead>
          <tr id="letter-row">
            <th class="logo-cell" id="logo-wrapper" style="cursor:pointer;">
              <img src="https://i.postimg.cc/SQ3RgNsQ/image.png" alt="Logo" style="width:35px;height:35px;" />
            </th>
            <th><input type="date" id="date-picker" /></th>
          </tr>
          <tr id="time-row">
            <th>LANE</th>
            <th id="overall-total">0—á 0–º</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJcg8Ov4_-ijxTLQxJDjm2-IKCmI8l0AAsDo4sMeU-avSQp3F_E54gyB7f26z_KaE0FA/exec';
const totalMinutes = 1440, timeColumns = 96, groupSize = 14;
const letterRow = document.getElementById('letter-row'),
      timeRow = document.getElementById('time-row'),
      overallTotal = document.getElementById('overall-total'),
      tableBody = document.getElementById('table-body'),
      datePicker = document.getElementById('date-picker'),
      statusEl = document.getElementById('status');

const allDataCells = [], allGroups = [], fetchControllers = new Map();
let isLoading = false;

function formatMinutes(mins){ const h=Math.floor(mins/60); const m=mins%60; return `${h}—á ${m}–º`; }

function makeBtn(idxs,title){
  const btn=document.createElement('div');
  btn.className='toggle-btn'; btn.title=title; btn.textContent='+';
  let last=0;
  btn.onclick=()=>{
    const now=Date.now();
    if(now-last<300) toggleAll(!areAllHidden());
    else { toggleGroup(idxs); btn.textContent=timeRow.children[idxs[0]+2].classList.contains('hidden-column')?'+':'‚Äì'; }
    last=now;
  };
  return btn;
}

function toggleGroup(idxs){
  idxs.forEach(i=>{
    [timeRow,letterRow].forEach(row=>{
      if(row.children[i+2]) row.children[i+2].classList.toggle('hidden-column');
    });
    tableBody.querySelectorAll('tr').forEach(tr=>{
      if(tr.children[i+2]) tr.children[i+2].classList.toggle('hidden-column');
    });
  });
}

function areAllHidden(){ return allGroups.every(g=>timeRow.children[g[0]+2].classList.contains('hidden-column')); }
function toggleAll(forceHide=null){
  const shouldHide = forceHide!==null?forceHide:!areAllHidden();
  allGroups.forEach(g=>{ const el=timeRow.children[g[0]+2]; if(el){ const hidden=el.classList.contains('hidden-column'); if(hidden!==shouldHide) toggleGroup(g); } });
  document.querySelectorAll('.toggle-btn').forEach(b=>b.textContent=shouldHide?'+':'‚Äì');
}

function buildHeaders(){
  const fragL=document.createDocumentFragment(), fragT=document.createDocumentFragment();
  for(let i=0;i<timeColumns;i++){
    const minutes=Math.floor(i*(totalMinutes/timeColumns)), h=Math.floor(minutes/60), m=minutes%60;
    const thL=document.createElement('th'); fragL.appendChild(thL);
    const thT=document.createElement('th');
    thT.innerHTML=`<div class="hour">${String(h).padStart(2,'0')}</div><div class="minute">${String(m).padStart(2,'0')}</div>`;
    fragT.appendChild(thT);
    
    if(i%groupSize===0){ 
      const start=i, end=Math.min(i+groupSize-1,timeColumns-1);
      const idxs=[]; for(let j=start;j<=end;j++) idxs.push(j);
      if(idxs.length){ thL.appendChild(makeBtn(idxs,`–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å ${formatMinutes(Math.floor(idxs[0]*(totalMinutes/timeColumns)))}‚Äì${formatMinutes(Math.floor(idxs[idxs.length-1]*(totalMinutes/timeColumns)))}`)); allGroups.push(idxs);}
    }
  }
  letterRow.appendChild(fragL); timeRow.appendChild(fragT);
}

function buildBody(){
  const frag=document.createDocumentFragment();
  for(let lane=0;lane<16;lane++){
    const tr=document.createElement('tr');
    const thLane=document.createElement('th'); thLane.textContent=lane+1; tr.appendChild(thLane);
    const thCount=document.createElement('th'); tr.appendChild(thCount);
    const cells=[];
    for(let i=0;i<timeColumns;i++){ const td=document.createElement('td'); tr.appendChild(td); cells.push(td); }
    frag.appendChild(tr); allDataCells.push({header:thCount,cells});
  }
  tableBody.appendChild(frag);
}

function clearRows(){
  fetchControllers.forEach(c=>c.abort()); fetchControllers.clear();
  overallTotal.textContent='0—á 0–º';
  allDataCells.forEach(r=>{ r.header.textContent=''; r.cells.forEach(c=>{c.classList.remove('active-cell');c.textContent='';c.style.color='';});});
}

function setStatus(message,isError=false){ statusEl.textContent=message; isError?statusEl.classList.add('error'):statusEl.classList.remove('error'); }

async function loadLaneData(idx,selectedDate){
  const controller=new AbortController(); fetchControllers.set(idx,controller);
  try{
    const url=`${SCRIPT_URL}?action=getData&index=${idx}&date=${selectedDate}&t=${Date.now()}`;
    const response=await fetch(url,{signal:controller.signal});
    if(!response.ok) throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
    const data=await response.json();
    if(data.error) throw new Error(data.error);
    return data;
  }finally{ fetchControllers.delete(idx); }
}

async function loadData(){
  if(!datePicker.value||isLoading) return;
  isLoading=true; clearRows(); setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
  const selectedDate=datePicker.value; let done=0,sumAll=0; const errors=[]; const promises=[];
  try{
    for(let idx=0;idx<allDataCells.length;idx++){
      promises.push(loadLaneData(idx,selectedDate).then(data=>{
        const row=allDataCells[idx]; let sum=0;
        row.cells.forEach((cell,i)=>{
          const minutes=Math.floor(i*(totalMinutes/timeColumns)), h=Math.floor(minutes/60), m=minutes%60;
          const time=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
          cell.classList.remove('active-cell');
          if(data.c && data.c.includes(time)){ cell.classList.add('active-cell'); cell.textContent='üé≥'; sum++; }
          else if(data.b && data.b.includes(time)){ cell.textContent=''; cell.style.color='black'; }
          else{ cell.textContent='‚ö°'; cell.style.color='#dc143c'; }
        });
        row.header.textContent=formatMinutes(sum); sumAll+=sum; done++;
        setStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${done} –∏–∑ 16 –¥–æ—Ä–æ–∂–µ–∫...`);
      }).catch(err=>{ errors.push(`–î–æ—Ä–æ–∂–∫–∞ ${idx+1}: ${err.message}`); done++; }));
    }
    await Promise.allSettled(promises);
    overallTotal.textContent=formatMinutes(sumAll);
    if(errors.length>0) setStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –æ—à–∏–±–∫–∞–º–∏: ${errors.join('; ')}`,true);
    else setStatus(`–î–∞–Ω–Ω—ã–µ –∑–∞ ${selectedDate} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –í—Å–µ–≥–æ: ${formatMinutes(sumAll)}`);
  }catch(e){ setStatus(`–û—à–∏–±–∫–∞: ${e.message}`,true); }
  finally{ isLoading=false; }
}

function init(){
  buildHeaders(); buildBody();
  datePicker.addEventListener('change', loadData);
  const t=new Date(); datePicker.value=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
  document.getElementById('logo-wrapper').addEventListener('click',()=>{datePicker.click();});
  setTimeout(loadData,500);
}

window.addEventListener('load',init);
</script>
</body>
</html>