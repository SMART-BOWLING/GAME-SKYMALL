<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ü–æ–≤–µ—Ä–Ω—É—Ç–∞—è —Ç–∞–±–ª–∏—Ü–∞ ‚Äì –¥–æ—Ä–æ–∂–∫–∏ —Å–ª–µ–≤–∞</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f4f6fa;
  margin: 0;
  padding: 20px;
  color: #333;
}
.table-wrapper {
  overflow: auto;
  max-width: 100%;
  position: relative;
}
table {
  border-collapse: collapse;
  background: #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  border-radius: 12px;
}
td, th {
  border: 1px solid #d7dce3;
  text-align: center;
  font-size: 13px;
  height: 30px;
  white-space: nowrap;
  vertical-align: middle;
  position: relative;
}
th {
  background: #ecf0f1;
  font-weight: 600;
  color: #1a2f40;
}
.hidden-column { display: none !important; }
.active-cell { background-color: #2c3e50; color:#fff; font-weight:700; }
td.hover-row, th.hover-row,
td.hover-col, th.hover-col { background:#fa849c !important; }
#date-picker {
  margin:10px 0;
  padding:6px 10px;
  font-size:13px;
  border-radius:6px;
  border:1px solid #ecf0f1;
  cursor:pointer;
}
.toggle-btn {
  cursor:pointer;
  user-select:none;
  color:#fff;
  background:#1a2f40;
  border-radius:4px;
  font-weight:bold;
  font-size:12px;
  padding:0 4px;
  display:inline-block;
  height:25px;
  line-height:25px;
  text-align:center;
}
.toggle-btn:hover { background:#dc143c; }
.status-message {
  text-align:center;
  padding:10px;
  margin-bottom:10px;
  border-radius:5px;
  background:#f8f9fa;
}
.error { background:#ffebee;color:#c62828 !important; }
</style>
</head>
<body>

<div id="status" class="status-message">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>
<input type="date" id="date-picker">

<div class="table-wrapper">
  <table id="main-table">
    <thead id="table-head">
      <tr>
        <th>–î–æ—Ä–æ–∂–∫–∞</th>
        <th>–í—Å–µ–≥–æ</th>
        <!-- —Å—é–¥–∞ –¥–æ–±–∞–≤—è—Ç—Å—è –º–∏–Ω—É—Ç—ã -->
      </tr>
    </thead>
    <tbody id="table-body">
      <!-- —Å—é–¥–∞ –¥–æ–±–∞–≤—è—Ç—Å—è –¥–æ—Ä–æ–∂–∫–∏ -->
    </tbody>
  </table>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJcg8Ov4_-ijxTLQxJDjm2-IKCmI8l0AAsDo4sMeU-avSQp3F_E54gyB7f26z_KaE0FA/exec';
const totalMinutes=1440, groupInterval=15, groupSize=14;

const tableBody=document.getElementById('table-body');
const tableHead=document.getElementById('table-head');
const datePicker=document.getElementById('date-picker');
const statusEl=document.getElementById('status');

const allGroups=[], allDataCells=[];
let isLoading=false;

// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –º–∏–Ω—É—Ç—ã
function formatMinutes(mins){
  const h=Math.floor(mins/60), m=mins%60;
  return `${h}—á ${m}–º`;
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
function makeBtn(idxs,title){
  const btn=document.createElement('div');
  btn.className='toggle-btn';
  btn.title=title;
  btn.textContent='+';
  btn.onclick=()=>{ toggleGroup(idxs); };
  return btn;
}

// –°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –≥—Ä—É–ø–ø—É
function toggleGroup(idxs){
  idxs.forEach(i=>{
    allDataCells.forEach(r=>{
      if(r.cells[i]) r.cells[i].classList.toggle('hidden-column');
    });
    if(tableHead.rows[0].cells[i+2]) tableHead.rows[0].cells[i+2].classList.toggle('hidden-column');
  });
}

// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–º–∏–Ω—É—Ç—ã)
function buildHeaders(){
  const headRow=tableHead.rows[0];
  for(let i=0;i<totalMinutes;i++){
    const th=document.createElement('th');
    const h=Math.floor(i/60), m=i%60;
    th.innerHTML=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    headRow.appendChild(th);

    if(i%groupInterval===0){
      const start=i,end=Math.min(i+groupSize-1,totalMinutes-1);
      const idxs=[];
      for(let j=start;j<=end;j++) idxs.push(j);
      allGroups.push(idxs);
      th.appendChild(makeBtn(idxs,`${formatMinutes(start)}‚Äì${formatMinutes(end)}`));
    }
  }
}

// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–æ—Ä–æ–∂–µ–∫
function buildBody(){
  for(let lane=0;lane<16;lane++){
    const tr=document.createElement('tr');
    const thLane=document.createElement('th');
    thLane.textContent=lane+1;
    tr.appendChild(thLane);

    const thCount=document.createElement('th');
    tr.appendChild(thCount);

    const cells=[];
    for(let i=0;i<totalMinutes;i++){
      const td=document.createElement('td');
      tr.appendChild(td);
      cells.push(td);
    }
    tableBody.appendChild(tr);
    allDataCells.push({header:thCount,cells});
  }
}

// –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
function clearRows(){
  allDataCells.forEach(r=>{
    r.header.textContent='';
    r.cells.forEach(c=>{ c.classList.remove('active-cell'); c.textContent=''; });
  });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ–¥–Ω–æ–π –¥–æ—Ä–æ–∂–∫–∏
async function loadLaneData(idx,date){
  try{
    const response=await fetch(`${SCRIPT_URL}?action=getData&index=${idx}&date=${date}&t=${Date.now()}`);
    return await response.json();
  }catch(e){console.error(e); return {}; }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
async function loadData(){
  if(!datePicker.value||isLoading) return;
  isLoading=true;
  clearRows();
  statusEl.textContent='–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
  const date=datePicker.value;
  let sumAll=0;
  const promises=[];
  for(let idx=0;idx<allDataCells.length;idx++){
    promises.push(loadLaneData(idx,date).then(data=>{
      const row=allDataCells[idx];
      let sum=0;
      row.cells.forEach((cell,i)=>{
        const time=`${String(Math.floor(i/60)).padStart(2,'0')}:${String(i%60).padStart(2,'0')}`;
        cell.classList.remove('active-cell');
        if(data.c&&data.c.includes(time)){ cell.classList.add('active-cell'); cell.textContent='üé≥'; sum++; }
        else if(data.b&&data.b.includes(time)){ cell.textContent=''; }
        else{ cell.textContent='‚ö°Ô∏é'; cell.style.color='#dc143c'; }
      });
      row.header.textContent=formatMinutes(sum);
      sumAll+=sum;
    }));
  }
  await Promise.all(promises);
  statusEl.textContent=`–î–∞–Ω–Ω—ã–µ –∑–∞ ${date} –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –í—Å–µ–≥–æ: ${formatMinutes(sumAll)}`;
  isLoading=false;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
window.addEventListener('load',()=>{
  buildHeaders();
  buildBody();
  const today=new Date();
  datePicker.value=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  datePicker.addEventListener('change',loadData);
  loadData();
});
</script>
</body>
</html>