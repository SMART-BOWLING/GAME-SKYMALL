<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–î–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–µ ‚Äì 16 —Ç–∞–±–ª–∏—Ü</title>
  <style>
    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6fa;
      color: #333;
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç–∞ */
    .rotation-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vh;
      height: 100vw;
      transform: rotate(90deg) translateX(-100%);
      transform-origin: top left;
      display: flex;
      flex-direction: column;
      padding: 10px;
      overflow: hidden;
    }
    
    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    
    /* –®–∞–ø–∫–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º –∏ –¥–∞—Ç–æ–π */
    .header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: linear-gradient(135deg, #2c3e50 0%, #1a2f40 100%);
      border-radius: 12px 12px 0 0;
      z-index: 100;
      flex-shrink: 0;
    }
    
    .logo-cell {
      flex-shrink: 0;
      margin-right: 16px;
      cursor: pointer;
    }
    
    .logo-cell img {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: block;
    }
    
    .date-container {
      flex: 1;
    }
    
    #date-picker {
      width: 100%;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 600;
      font-family: 'Segoe UI', 'Arial', sans-serif;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      outline: none;
      transition: all 0.2s ease;
    }
    
    #date-picker:hover,
    #date-picker:focus {
      background-color: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }
    
    #date-picker::-webkit-calendar-picker-indicator {
      filter: invert(1);
      opacity: 0.8;
      cursor: pointer;
    }
    
    /* –û–±—â–∏–π —Ç–æ—Ç–∞–ª */
    .total-display {
      padding: 8px 16px;
      background-color: #ecf0f1;
      font-size: 14px;
      font-weight: 600;
      color: #2c3e50;
      text-align: center;
      border-bottom: 1px solid #d7dce3;
      flex-shrink: 0;
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–∞–±–ª–∏—Ü—ã —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏ */
    .table-scroll-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      -webkit-overflow-scrolling: touch;
    }
    
    .table-wrapper {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    /* –°—Ç–∏–ª–∏ —Ç–∞–±–ª–∏—Ü—ã */
    table {
      border-collapse: collapse;
      width: auto;
      table-layout: fixed;
      background-color: white;
      min-width: 800px;
    }
    
    /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤—ã–µ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ */
    #main-table th:nth-child(1),
    #main-table td:nth-child(1) {
      position: sticky;
      left: 0;
      z-index: 20;
      background-color: #dc143c;
      color: white;
      width: 45px;
      min-width: 45px;
      max-width: 45px;
      font-weight: 700;
      text-align: center;
    }
    
    #main-table th:nth-child(2),
    #main-table td:nth-child(2) {
      position: sticky;
      left: 45px;
      z-index: 19;
      background-color: #2c3e50;
      color: white;
      width: 85px;
      min-width: 85px;
      max-width: 85px;
      text-align: center;
      font-weight: 600;
    }
    
    /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤—Ä–µ–º–µ–Ω–∏ */
    #letter-row th,
    #time-row th {
      background-color: #f8f9fa;
      color: #2c3e50;
      border: 1px solid #e9ecef;
      font-weight: 600;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    #letter-row th:nth-child(n+3) {
      width: 24px;
      min-width: 24px;
      max-width: 24px;
      padding: 0;
    }
    
    #time-row th:nth-child(n+3) {
      width: 24px;
      min-width: 24px;
      max-width: 24px;
      padding: 2px 0;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —è—á–µ–µ–∫ */
    td, th {
      height: 24px;
      font-size: 11px;
      border: 1px solid #e9ecef;
      text-align: center;
      vertical-align: middle;
      white-space: nowrap;
      padding: 0 2px;
      transition: background-color 0.15s ease;
    }
    
    td {
      background-color: white;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —è—á–µ–µ–∫ */
    .active-cell {
      background-color: #2c3e50 !important;
      color: white !important;
      font-weight: 700;
    }
    
    .busy-cell {
      color: #666;
      font-weight: 500;
    }
    
    .free-cell {
      color: #dc143c;
      font-weight: 600;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ */
    .toggle-btn {
      display: block;
      width: 100%;
      height: 100%;
      background-color: #1a2f40;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-size: 10px;
      line-height: 1;
      transition: all 0.2s ease;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      user-select: none;
    }
    
    .toggle-btn:hover {
      background-color: #dc143c;
    }
    
    .toggle-btn:active {
      transform: scale(0.95);
    }
    
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö */
    .time-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    
    .hour-label {
      font-size: 9px;
      font-weight: 700;
      line-height: 1.1;
    }
    
    .minute-label {
      font-size: 9px;
      line-height: 1.1;
      opacity: 0.9;
    }
    
    /* –°–∫—Ä—ã—Ç—ã–µ –∫–æ–ª–æ–Ω–∫–∏ */
    .hidden-column {
      display: none !important;
    }
    
    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫ –∏ –∫–æ–ª–æ–Ω–æ–∫ */
    .hover-row {
      background-color: rgba(250, 132, 156, 0.15) !important;
    }
    
    .hover-col {
      background-color: rgba(250, 132, 156, 0.1) !important;
    }
    
    /* –°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ */
    .status-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px 30px;
      border-radius: 10px;
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 15px;
      font-size: 16px;
      font-weight: 500;
    }
    
    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    @media (max-width: 768px) {
      .rotation-container {
        width: 100vh;
        height: 100vw;
        padding: 8px;
      }
      
      .header {
        padding: 10px 12px;
      }
      
      .logo-cell img {
        width: 36px;
        height: 36px;
      }
      
      #date-picker {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      #main-table th:nth-child(1),
      #main-table td:nth-child(1) {
        width: 40px;
        min-width: 40px;
        max-width: 40px;
      }
      
      #main-table th:nth-child(2),
      #main-table td:nth-child(2) {
        left: 40px;
        width: 75px;
        min-width: 75px;
        max-width: 75px;
      }
      
      td, th {
        height: 22px;
        font-size: 10px;
      }
      
      #letter-row th:nth-child(n+3),
      #time-row th:nth-child(n+3) {
        width: 22px;
        min-width: 22px;
        max-width: 22px;
      }
      
      .hour-label,
      .minute-label {
        font-size: 8px;
      }
    }
    
    @media (max-width: 480px) {
      .rotation-container {
        padding: 6px;
      }
      
      .header {
        padding: 8px 10px;
      }
      
      .logo-cell img {
        width: 32px;
        height: 32px;
      }
      
      #date-picker {
        padding: 7px 10px;
        font-size: 12px;
      }
      
      #main-table th:nth-child(1),
      #main-table td:nth-child(1) {
        width: 35px;
        min-width: 35px;
        max-width: 35px;
      }
      
      #main-table th:nth-child(2),
      #main-table td:nth-child(2) {
        left: 35px;
        width: 65px;
        min-width: 65px;
        max-width: 65px;
      }
      
      td, th {
        height: 20px;
        font-size: 9px;
      }
      
      #letter-row th:nth-child(n+3),
      #time-row th:nth-child(n+3) {
        width: 20px;
        min-width: 20px;
        max-width: 20px;
      }
    }
    
    /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
    @media (prefers-color-scheme: dark) {
      .rotation-container {
        background-color: #1a1a1a;
      }
      
      .container {
        background-color: #2d2d2d;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }
      
      td {
        background-color: #2d2d2d;
        color: #e0e0e0;
        border-color: #404040;
      }
      
      #letter-row th,
      #time-row th {
        background-color: #3a3a3a;
        color: #e0e0e0;
        border-color: #404040;
      }
      
      .total-display {
        background-color: #3a3a3a;
        color: #e0e0e0;
        border-color: #404040;
      }
      
      .free-cell {
        color: #ff6b8b;
      }
    }
  </style>
</head>
<body>
  <div class="rotation-container">
    <div class="container">
      <div class="header">
        <div class="logo-cell" id="logo-wrapper">
          <img src="https://i.postimg.cc/SQ3RgNsQ/image.png" alt="Logo">
        </div>
        <div class="date-container">
          <input type="date" id="date-picker">
        </div>
      </div>
      
      <div class="total-display">
        –û–±—â–µ–µ –≤—Ä–µ–º—è: <span id="overall-total">0—á 0–º</span>
      </div>
      
      <div class="table-scroll-container">
        <div class="table-wrapper">
          <table id="main-table">
            <thead>
              <tr id="letter-row"></tr>
              <tr id="time-row"></tr>
            </thead>
            <tbody id="table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <div class="status-container" id="status-container">
    <div class="loading-spinner"></div>
    <span id="status-message">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
  </div>

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const CONFIG = {
      SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwJcg8Ov4_-ijxTLQxJDjm2-IKCmI8l0AAsDo4sMeU-avSQp3F_E54gyB7f26z_KaE0FA/exec',
      TOTAL_MINUTES: 1440, // 24 —á–∞—Å–∞ * 60 –º–∏–Ω—É—Ç
      GROUP_INTERVAL: 15,  // –ò–Ω—Ç–µ—Ä–≤–∞–ª –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
      GROUP_SIZE: 14,      // –†–∞–∑–º–µ—Ä –≥—Ä—É–ø–ø—ã
      LANE_COUNT: 16,      // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Ä–æ–∂–µ–∫
      MIN_CELL_WIDTH: 24   // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —è—á–µ–π–∫–∏
    };

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let allGroups = [];
    let allDataCells = [];
    let isLoading = false;
    let currentDate = '';
    const fetchControllers = new Map();
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const letterRow = document.getElementById('letter-row');
    const timeRow = document.getElementById('time-row');
    const overallTotal = document.getElementById('overall-total');
    const tableBody = document.getElementById('table-body');
    const datePicker = document.getElementById('date-picker');
    const statusContainer = document.getElementById('status-container');
    const statusMessage = document.getElementById('status-message');
    const tableWrapper = document.querySelector('.table-wrapper');

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function formatMinutes(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${h}—á ${m}–º`;
    }

    function showStatus(message) {
      statusMessage.textContent = message;
      statusContainer.style.display = 'flex';
    }

    function hideStatus() {
      statusContainer.style.display = 'none';
    }

    // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ç–∞–±–ª–∏—Ü—ã
    function buildHeaders() {
      // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
      letterRow.innerHTML = '<th>LANE</th><th>–í–†–ï–ú–Ø</th>';
      timeRow.innerHTML = '<th></th><th></th>';
      
      const letterFrag = document.createDocumentFragment();
      const timeFrag = document.createDocumentFragment();
      
      // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –º–∏–Ω—É—Ç—ã
      for (let i = 1; i <= CONFIG.TOTAL_MINUTES; i++) {
        const hour = Math.floor((i - 1) / 60);
        const minute = (i - 1) % 60;
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –±—É–∫–≤–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
        const thLetter = document.createElement('th');
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
        const thTime = document.createElement('th');
        const timeDiv = document.createElement('div');
        timeDiv.className = 'time-header';
        
        const hourSpan = document.createElement('span');
        hourSpan.className = 'hour-label';
        hourSpan.textContent = String(hour).padStart(2, '0');
        
        const minuteSpan = document.createElement('span');
        minuteSpan.className = 'minute-label';
        minuteSpan.textContent = String(minute).padStart(2, '0');
        
        timeDiv.appendChild(hourSpan);
        timeDiv.appendChild(minuteSpan);
        thTime.appendChild(timeDiv);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
        if ((hour * 60 + minute) % CONFIG.GROUP_INTERVAL === 0) {
          const startIdx = (hour * 60 + minute === 0) ? 1 : (hour * 60 + minute) + 1;
          const endIdx = Math.min(startIdx + CONFIG.GROUP_SIZE - 1, CONFIG.TOTAL_MINUTES - 1);
          
          const groupIdxs = [];
          for (let j = startIdx; j <= endIdx; j++) {
            groupIdxs.push(j);
          }
          
          if (groupIdxs.length > 0) {
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'toggle-btn';
            toggleBtn.textContent = '+';
            toggleBtn.title = `–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å ${formatMinutes(groupIdxs[0])}‚Äì${formatMinutes(groupIdxs[groupIdxs.length-1])}`;
            
            toggleBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              toggleGroup(groupIdxs);
              toggleBtn.textContent = timeRow.children[groupIdxs[0] + 2]?.classList.contains('hidden-column') ? '+' : '‚Äì';
            });
            
            thLetter.appendChild(toggleBtn);
            allGroups.push(groupIdxs);
          }
        }
        
        letterFrag.appendChild(thLetter);
        timeFrag.appendChild(thTime);
      }
      
      letterRow.appendChild(letterFrag);
      timeRow.appendChild(timeFrag);
    }

    // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ç–µ–ª–∞ —Ç–∞–±–ª–∏—Ü—ã
    function buildBody() {
      tableBody.innerHTML = '';
      allDataCells = [];
      
      for (let lane = 0; lane < CONFIG.LANE_COUNT; lane++) {
        const row = document.createElement('tr');
        
        // –ù–æ–º–µ—Ä –¥–æ—Ä–æ–∂–∫–∏
        const laneCell = document.createElement('th');
        laneCell.textContent = lane + 1;
        row.appendChild(laneCell);
        
        // –Ø—á–µ–π–∫–∞ –¥–ª—è –∏—Ç–æ–≥–∞ –ø–æ –¥–æ—Ä–æ–∂–∫–µ
        const totalCell = document.createElement('th');
        totalCell.textContent = '0—á 0–º';
        row.appendChild(totalCell);
        
        // –Ø—á–µ–π–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –º–∏–Ω—É—Ç—ã
        const cells = [];
        for (let i = 0; i < CONFIG.TOTAL_MINUTES; i++) {
          const cell = document.createElement('td');
          cell.dataset.minute = i;
          cell.dataset.lane = lane;
          row.appendChild(cell);
          cells.push(cell);
        }
        
        tableBody.appendChild(row);
        allDataCells.push({
          row: row,
          totalCell: totalCell,
          cells: cells
        });
      }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≥—Ä—É–ø–ø—ã
    function toggleGroup(idxs) {
      idxs.forEach(idx => {
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
        if (letterRow.children[idx + 2]) {
          letterRow.children[idx + 2].classList.toggle('hidden-column');
        }
        if (timeRow.children[idx + 2]) {
          timeRow.children[idx + 2].classList.toggle('hidden-column');
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —è—á–µ–π–∫–∏ –≤ —Ç–µ–ª–µ —Ç–∞–±–ª–∏—Ü—ã
        tableBody.querySelectorAll('tr').forEach(row => {
          if (row.children[idx + 2]) {
            row.children[idx + 2].classList.toggle('hidden-column');
          }
        });
      });
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –≤—Å–µ –ª–∏ –≥—Ä—É–ø–ø—ã —Å–∫—Ä—ã—Ç—ã
    function areAllHidden() {
      return allGroups.every(group => {
        const el = timeRow.children[group[0] + 2];
        return el && el.classList.contains('hidden-column');
      });
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö –≥—Ä—É–ø–ø
    function toggleAll(forceHide = null) {
      const shouldHide = forceHide !== null ? forceHide : !areAllHidden();
      
      allGroups.forEach(group => {
        const el = timeRow.children[group[0] + 2];
        if (el) {
          const hidden = el.classList.contains('hidden-column');
          if (hidden !== shouldHide) {
            toggleGroup(group);
          }
        }
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–æ–∫
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.textContent = shouldHide ? '+' : '‚Äì';
      });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–¥–Ω–æ–π –¥–æ—Ä–æ–∂–∫–∏
    async function loadLaneData(laneIndex, date) {
      const controller = new AbortController();
      fetchControllers.set(laneIndex, controller);
      
      try {
        const url = `${CONFIG.SCRIPT_URL}?action=getData&index=${laneIndex}&date=${date}&t=${Date.now()}`;
        const response = await fetch(url, { 
          signal: controller.signal,
          mode: 'cors'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        return data;
      } finally {
        fetchControllers.delete(laneIndex);
      }
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    async function loadData() {
      const selectedDate = datePicker.value;
      if (!selectedDate || isLoading) return;
      
      // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã
      fetchControllers.forEach(controller => controller.abort());
      fetchControllers.clear();
      
      isLoading = true;
      currentDate = selectedDate;
      
      showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
      
      // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
      allDataCells.forEach(rowData => {
        rowData.totalCell.textContent = '0—á 0–º';
        rowData.cells.forEach(cell => {
          cell.textContent = '';
          cell.className = '';
          cell.style.color = '';
        });
      });
      
      overallTotal.textContent = '0—á 0–º';
      
      try {
        const promises = [];
        let loadedCount = 0;
        let totalBookings = 0;
        
        for (let laneIndex = 0; laneIndex < CONFIG.LANE_COUNT; laneIndex++) {
          const promise = loadLaneData(laneIndex, selectedDate)
            .then(data => {
              const rowData = allDataCells[laneIndex];
              let laneBookings = 0;
              
              // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫–∏
              rowData.cells.forEach((cell, minuteIndex) => {
                const hour = Math.floor(minuteIndex / 60);
                const minute = minuteIndex % 60;
                const timeKey = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                
                // –û—á–∏—â–∞–µ–º –∫–ª–∞—Å—Å—ã
                cell.className = '';
                cell.style.color = '';
                
                if (data.c && data.c.includes(timeKey)) {
                  // –ó–∞–Ω—è—Ç–æ (–±—Ä–æ–Ω—å)
                  cell.textContent = 'üé≥';
                  cell.classList.add('active-cell');
                  laneBookings++;
                } else if (data.b && data.b.includes(timeKey)) {
                  // –ó–∞–Ω—è—Ç–æ (–Ω–µ –±—Ä–æ–Ω—å)
                  cell.textContent = '‚óè';
                  cell.classList.add('busy-cell');
                } else {
                  // –°–≤–æ–±–æ–¥–Ω–æ
                  cell.textContent = '‚ö°Ô∏é';
                  cell.classList.add('free-cell');
                }
              });
              
              // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥ –ø–æ –¥–æ—Ä–æ–∂–∫–µ
              rowData.totalCell.textContent = formatMinutes(laneBookings);
              totalBookings += laneBookings;
              
              loadedCount++;
              showStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${loadedCount} –∏–∑ ${CONFIG.LANE_COUNT} –¥–æ—Ä–æ–∂–µ–∫...`);
            })
            .catch(error => {
              console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Ä–æ–∂–∫–∏ ${laneIndex + 1}:`, error);
              loadedCount++;
              
              // –ü–æ–º–µ—á–∞–µ–º –¥–æ—Ä–æ–∂–∫—É –∫–∞–∫ –æ—à–∏–±–æ—á–Ω—É—é
              const rowData = allDataCells[laneIndex];
              rowData.totalCell.textContent = '–û—à–∏–±–∫–∞';
              rowData.totalCell.style.color = '#dc143c';
            });
          
          promises.push(promise);
        }
        
        await Promise.allSettled(promises);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π –∏—Ç–æ–≥
        overallTotal.textContent = formatMinutes(totalBookings);
        
        hideStatus();
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        setTimeout(hideStatus, 3000);
      } finally {
        isLoading = false;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å—Ç—Ä–æ–∫ –∏ –∫–æ–ª–æ–Ω–æ–∫
    function initHoverEffects() {
      let hoverTimeout;
      
      tableWrapper.addEventListener('mouseover', (e) => {
        if (!e.target.matches('td, th')) return;
        
        clearTimeout(hoverTimeout);
        
        const cell = e.target;
        const row = cell.closest('tr');
        const colIndex = cell.cellIndex;
        
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏
        if (row && row.tagName === 'TR') {
          row.querySelectorAll('td, th').forEach(c => {
            c.classList.add('hover-row');
          });
        }
        
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–ª–æ–Ω–∫–∏
        if (colIndex >= 0) {
          document.querySelectorAll('#main-table tr').forEach(r => {
            const colCell = r.children[colIndex];
            if (colCell) {
              colCell.classList.add('hover-col');
            }
          });
        }
      });
      
      tableWrapper.addEventListener('mouseout', (e) => {
        hoverTimeout = setTimeout(() => {
          document.querySelectorAll('.hover-row, .hover-col').forEach(el => {
            el.classList.remove('hover-row', 'hover-col');
          });
        }, 100);
      });
      
      // –î–ª—è —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      tableWrapper.addEventListener('touchstart', (e) => {
        if (e.target.matches('td, th')) {
          const cell = e.target;
          const row = cell.closest('tr');
          const colIndex = cell.cellIndex;
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É
          document.querySelectorAll('.hover-row, .hover-col').forEach(el => {
            el.classList.remove('hover-row', 'hover-col');
          });
          
          // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏
          if (row && row.tagName === 'TR') {
            row.querySelectorAll('td, th').forEach(c => {
              c.classList.add('hover-row');
            });
          }
          
          // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–ª–æ–Ω–∫–∏
          if (colIndex >= 0) {
            document.querySelectorAll('#main-table tr').forEach(r => {
              const colCell = r.children[colIndex];
              if (colCell) {
                colCell.classList.add('hover-col');
              }
            });
          }
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
          setTimeout(() => {
            document.querySelectorAll('.hover-row, .hover-col').forEach(el => {
              el.classList.remove('hover-row', '.hover-col');
            });
          }, 1000);
        }
      }, { passive: true });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    function initApp() {
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      datePicker.value = todayStr;
      currentDate = todayStr;
      
      // –°—Ç—Ä–æ–∏–º —Ç–∞–±–ª–∏—Ü—É
      buildHeaders();
      buildBody();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
      initHoverEffects();
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      datePicker.addEventListener('change', () => {
        loadData();
      });
      
      document.getElementById('logo-wrapper').addEventListener('click', () => {
        datePicker.focus();
        datePicker.showPicker?.();
      });
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      setTimeout(() => {
        loadData();
        // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å–µ –≥—Ä—É–ø–ø—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        setTimeout(() => toggleAll(true), 100);
      }, 500);
      
      // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      if ('ontouchstart' in window) {
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑—É–º –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º —Ç–∞–ø–µ
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
          const now = Date.now();
          if (now - lastTouchEnd <= 300) {
            e.preventDefault();
          }
          lastTouchEnd = now;
        }, false);
        
        // –£–ª—É—á—à–∞–µ–º —Å–∫—Ä–æ–ª–ª–∏–Ω–≥
        tableWrapper.style.webkitOverflowScrolling = 'touch';
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
      window.addEventListener('resize', () => {
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
      });
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    window.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>