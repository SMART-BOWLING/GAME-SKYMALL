<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–î–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–µ ‚Äì 16 —Ç–∞–±–ª–∏—Ü –ø–æ–≤–µ—Ä–Ω—É—Ç—ã–µ</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6fa;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .table-wrapper {
      overflow: auto;
      position: relative;
      max-width: 100%;
      margin: 0 auto;
    }

    table {
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border-radius: 12px;
    }

    td, th {
      height: 30px;
      text-align: center;
      font-size: 13px;
      border: 1px solid #d7dce3;
      white-space: nowrap;
      vertical-align: middle;
      position: relative;
      transition: background-color 0.2s ease;
    }

    th {
      background-color: #ecf0f1;
      color: #1a2f40;
      font-weight: 600;
    }

    .hidden-column { display: none !important; }
    .active-cell { background-color: #2c3e50; color: #fff; font-weight: 700; }
    td.hover-row, th.hover-row,
    td.hover-col, th.hover-col { background-color: #fa849c !important; }

    #date-picker {
      width: 100%;
      padding: 8px;
      font-size: 13px;
      border: 1px solid #ecf0f1;
      border-radius: 10px;
      background-color: #ecf0f1;
      color: #1a2f40;
      box-sizing: border-box;
      cursor: pointer;
    }

    .toggle-btn {
      cursor: pointer;
      user-select: none;
      color: #fff;
      background-color: #1a2f40;
      border-radius: 4px;
      font-weight: bold;
      font-size: 14px;
      line-height: 27px;
      padding: 0 6px;
      display: inline-block;
      width: 10px;
      height: 30px;
      text-align: center;
      transition: background-color 0.1s ease;
    }
    .toggle-btn:hover { background-color: #dc143c; }

    .status-message {
      text-align: center;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      background-color: #f8f9fa;
      font-size: 14px;
    }
    .error { background-color: #ffebee !important; color: #c62828 !important; }
  </style>
</head>
<body>
  <div id="status" class="status-message">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>

  <div class="table-wrapper" id="table-container">
    <table id="main-table">
      <thead>
        <tr id="header-row">
          <th></th>
          <th>–î–æ—Ä–æ–∂–∫–∞</th>
          <th id="overall-total">0—á 0–º</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

  <input type="date" id="date-picker" />

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJcg8Ov4_-ijxTLQxJDjm2-IKCmI8l0AAsDo4sMeU-avSQp3F_E54gyB7f26z_KaE0FA/exec';
    const totalMinutes = 1440, groupInterval = 15, groupSize = 14;

    const tableBody = document.getElementById('table-body');
    const headerRow = document.getElementById('header-row');
    const overallTotal = document.getElementById('overall-total');
    const datePicker = document.getElementById('date-picker');
    const statusEl = document.getElementById('status');

    const allGroups = [], allDataCells = [];
    let isLoading = false;

    function formatMinutes(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${h}—á ${m}–º`;
    }

    function makeBtn(idxs, title) {
      const btn = document.createElement('div');
      btn.className = 'toggle-btn';
      btn.title = title;
      btn.textContent = '+';
      let last = 0;
      btn.onclick = () => {
        const now = Date.now();
        if (now - last < 300) toggleAll(!areAllHidden());
        else {
          toggleGroup(idxs);
          btn.textContent = tableBody.querySelectorAll('tr')[idxs[0]].children[2].classList.contains('hidden-column') ? '+' : '‚Äì';
        }
        last = now;
      };
      return btn;
    }

    function toggleGroup(idxs) {
      idxs.forEach(i => {
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach((tr,j)=> {
          if(tr.children[i+2]) tr.children[i+2].classList.toggle('hidden-column');
        });
        if(headerRow.children[i+2]) headerRow.children[i+2].classList.toggle('hidden-column');
      });
    }

    function areAllHidden() {
      return allGroups.every(g => {
        const el = tableBody.querySelectorAll('tr')[g[0]].children[2];
        return el && el.classList.contains('hidden-column');
      });
    }

    function toggleAll(forceHide=null) {
      const shouldHide = forceHide !== null ? forceHide : !areAllHidden();
      allGroups.forEach(g => toggleGroup(g));
    }

    function buildTable() {
      // —Å–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏
      for(let lane=0; lane<16; lane++){
        const tr = document.createElement('tr');
        const thLane = document.createElement('th');
        thLane.textContent = lane+1;
        tr.appendChild(thLane);
        const thCount = document.createElement('th'); 
        tr.appendChild(thCount);

        const cells = [];
        for(let i=0;i<totalMinutes;i++){
          const td = document.createElement('td');
          tr.appendChild(td);
          cells.push(td);
        }
        tableBody.appendChild(tr);
        allDataCells.push({header: thCount, cells});
      }

      // —Å–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–ø–æ–≤–æ—Ä–æ—Ç)
      for(let i=0;i<totalMinutes;i++){
        const th = document.createElement('th');
        th.innerHTML = i;
        headerRow.appendChild(th);

        if(i%groupInterval===0){
          const start=i, end=Math.min(i+groupSize-1,totalMinutes-1);
          const idxs = [];
          for(let j=start;j<=end;j++) idxs.push(j);
          allGroups.push(idxs);
        }
      }
    }

    function clearRows() {
      overallTotal.textContent = '0—á 0–º';
      allDataCells.forEach(r => {
        r.header.textContent = '';
        r.cells.forEach(c => { c.classList.remove('active-cell'); c.textContent=''; });
      });
    }

    async function loadLaneData(idx, selectedDate) {
      try {
        const response = await fetch(`${SCRIPT_URL}?action=getData&index=${idx}&date=${selectedDate}&t=${Date.now()}`);
        return await response.json();
      } catch(err){ console.error(err); return {}; }
    }

    async function loadData() {
      if(!datePicker.value || isLoading) return;
      isLoading=true;
      clearRows();
      statusEl.textContent='–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
      const selectedDate=datePicker.value;
      let sumAll=0;
      const promises=[];
      for(let idx=0;idx<allDataCells.length;idx++){
        promises.push(
          loadLaneData(idx, selectedDate).then(data=>{
            const row=allDataCells[idx];
            let sum=0;
            row.cells.forEach((cell,i)=>{
              const time = `${String(Math.floor(i/60)).padStart(2,'0')}:${String(i%60).padStart(2,'0')}`;
              cell.classList.remove('active-cell');
              if(data.c && data.c.includes(time)){
                cell.classList.add('active-cell');
                cell.textContent='üé≥'; sum++;
              } else if(data.b && data.b.includes(time)){ cell.textContent=''; }
              else { cell.textContent='‚ö°Ô∏é'; cell.style.color='#dc143c'; }
            });
            row.header.textContent=formatMinutes(sum);
            sumAll+=sum;
          })
        );
      }
      await Promise.all(promises);
      overallTotal.textContent=formatMinutes(sumAll);
      statusEl.textContent=`–î–∞–Ω–Ω—ã–µ –∑–∞ ${selectedDate} –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –í—Å–µ–≥–æ: ${formatMinutes(sumAll)}`;
      isLoading=false;
    }

    window.addEventListener('load', ()=>{
      buildTable();
      datePicker.addEventListener('change',loadData);
      const t = new Date();
      datePicker.value=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
      loadData();
    });
  </script>
</body>
</html>