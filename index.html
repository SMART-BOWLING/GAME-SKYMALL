<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Данные по дате – 16 таблиц</title>
  <style>
    /* Стиль для кнопки поворота */
    .rotate-button {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background-color: #2c3e50;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .rotate-button:hover {
      background-color: #dc143c;
    }
    
    /* Стиль для повернутой страницы */
    body.rotated {
      transform: rotate(90deg);
      transform-origin: center center;
      width: 100vh;
      height: 100vw;
      position: fixed;
      top: 50%;
      left: 50%;
      margin-top: -50vw;
      margin-left: -50vh;
      overflow: hidden;
      padding: 0;
    }
    
    /* Контейнер для повернутого режима */
    .rotated-container {
      display: none;
      width: 100%;
      height: 100%;
    }
    
    body.rotated .rotated-container {
      display: block;
    }
    
    body.rotated .normal-container {
      display: none;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6fa;
      margin: 0;
      padding: 20px;
      color: #333;
      transition: transform 0.3s ease;
      box-sizing: border-box;
    }
    
    .normal-container {
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }

    .table-wrapper {
      overflow-x: auto;
      overflow-y: visible;
      position: relative;
      -webkit-overflow-scrolling: touch;
      max-width: 100%;
      margin: 0 auto;
    }
    
    /* Улучшенное отображение таблицы в повернутом режиме */
    body.rotated .table-wrapper {
      width: 100vw;
      height: calc(100vh - 40px);
      overflow: auto;
    }
    
    body.rotated table {
      min-width: auto;
      max-width: none;
    }
    
    body.rotated .table-wrapper::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    body.rotated .table-wrapper::-webkit-scrollbar-thumb {
      background: #2c3e50;
      border-radius: 4px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: auto;
      background-color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      min-width: 800px;
    }

    td, th {
      height: 30px;
      text-align: center;
      font-size: 13px;
      border: 1px solid #d7dce3;
      box-sizing: border-box;
      white-space: nowrap;
      vertical-align: middle;
      position: relative;
      transition: background-color 0.2s ease;
    }

    th {
      background-color: #ecf0f1;
      color: #1a2f40;
      font-weight: 600;
    }

    /* Фиксированные первые два столбца */
    #main-table th:nth-child(1),
    #main-table td:nth-child(1),
    #main-table th:nth-child(2),
    #main-table td:nth-child(2) {
      position: sticky;
    }
    #main-table th:nth-child(1),
    #main-table td:nth-child(1) {
      left: 0;
      z-index: 3;
      background-color: #dc143c;
      color: white;
      width: 50px;
      min-width: 50px;
      max-width: 50px;
    }
    #main-table th:nth-child(2),
    #main-table td:nth-child(2) {
      left: 50px;
      z-index: 5;
      background-color: #2c3e50;
      color: white;
      width: 120px;
      min-width: 120px;
      max-width: 120px;
      overflow: hidden;
    }

    /* Заголовки первой и второй строки */
    #letter-row th:nth-child(1),
    #letter-row th:nth-child(2),
    #time-row th:nth-child(1),
    #time-row th:nth-child(2) {
      background-color: #ecf0f1 !important;
      color: #2c3e50 !important;
      border: 0px solid #d7dce3 !important;
      z-index: 4;
    }

    #letter-row th:nth-child(n+3) {
      background-color: #ecf0f1 !important;
      color: #2c3e50;
      border: 1px solid #e0e0e0 !important;
    }
    #time-row th:nth-child(n+3) {
      white-space: normal;
      padding: 4px 2px;
      line-height: 1;
      vertical-align: middle;
      border: 1px solid #e0e0e0;
      width: auto;
    }
    #time-row th div {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #time-row th .hour {
      font-size: 12px;
      font-weight: bold;
    }
    #time-row th .minute {
      font-size: 12px;
    }

    .hidden-column {
      display: none !important;
    }
    .active-cell {
      background-color: #2c3e50;
      color: #fff;
      font-weight: 700;
    }
    td.hover-row, th.hover-row,
    td.hover-col, th.hover-col {
      background-color: #fa849c !important;
    }

    #date-picker {
      width: 100%;
      padding: 8px;
      font-size: 13px;
      font-family: 'Arial Black','Impact', sans-serif;
      border: 1px solid #ecf0f1;
      border-radius: 10px;
      background-color: #ecf0f1;
      color: #1a2f40;
      box-sizing: border-box;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      outline: none;
    }
    #date-picker:hover {
      background-color: #e0e0e0;
    }
    #date-picker::-webkit-calendar-picker-indicator {
      filter: invert(0.3);
      cursor: pointer;
    }

    /* Кнопки группировки */
    .toggle-btn {
      cursor: pointer;
      user-select: none;
      color: #fff;
      background-color: #1a2f40;
      border-radius: 4px;
      font-weight: bold;
      font-size: 14px;
      line-height: 27px;
      padding: 0 6px;
      display: inline-block;
      width: 10px;
      height: 30px;
      text-align: center;
      transition: background-color 0.1s ease;
    }
    .toggle-btn:hover {
      background-color: #dc143c;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status-message {
      text-align: center;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      background-color: #f8f9fa;
      font-size: 14px;
    }

    .error {
      background-color: #ffebee !important;
      color: #c62828 !important;
    }

    .success {
      color: #2e7d32;
    }

    @media (max-width: 768px) {
      body { padding: 10px; }
      .table-wrapper { overflow-x: scroll; }
      table { min-width: 100%; }
      #main-table th:nth-child(1),
      #main-table td:nth-child(1) { width: 40px; min-width: 40px; max-width: 40px; }
      #main-table th:nth-child(2),
      #main-table td:nth-child(2) { left: 40px; width: 100px; min-width: 100px; max-width: 100px; }
      td, th { font-size: 12px; height: 25px; }
      #time-row th .hour, #time-row th .minute { font-size: 10px; }
      .toggle-btn { font-size: 12px; height: 25px; line-height: 22px; }
      
      /* Адаптация для повернутого режима на мобильных */
      body.rotated {
        padding: 5px;
      }
      
      body.rotated .table-wrapper {
        height: calc(100vh - 10px);
      }
      
      body.rotated td, 
      body.rotated th {
        font-size: 11px;
        height: 22px;
        padding: 2px;
      }
      
      body.rotated #main-table th:nth-child(1),
      body.rotated #main-table td:nth-child(1) { 
        width: 35px; 
        min-width: 35px; 
        max-width: 35px; 
      }
      
      body.rotated #main-table th:nth-child(2),
      body.rotated #main-table td:nth-child(2) { 
        left: 35px; 
        width: 90px; 
        min-width: 90px; 
        max-width: 90px; 
      }
      
      body.rotated #time-row th .hour, 
      body.rotated #time-row th .minute { 
        font-size: 9px; 
      }
    }
  </style>
</head>
<body>
  <!-- Кнопка поворота страницы -->
  <button class="rotate-button" id="rotate-button">↻ Повернуть</button>
  
  <div class="normal-container">
    <div id="status" class="status-message">Выберите дату для загрузки данных</div>
    
    <div class="table-wrapper">
      <table id="main-table">
        <thead>
          <tr id="letter-row">
            <th class="logo-cell" id="logo-wrapper" style="cursor: pointer;">
              <img src="https://i.postimg.cc/SQ3RgNsQ/image.png" alt="Logo" style="width:45px;height:45px;border-radius:0;" />
            </th>
            <th>
              <input type="date" id="date-picker" />
            </th>
          </tr>
          <tr id="time-row">
            <th>LANE</th>
            <th id="overall-total">0ч 0м</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>
  
  <div class="rotated-container">
    <div id="status-rotated" class="status-message">Выберите дату для загрузки данных</div>
    
    <div class="table-wrapper">
      <table id="main-table-rotated">
        <thead>
          <tr id="letter-row-rotated">
            <th class="logo-cell" id="logo-wrapper-rotated" style="cursor: pointer;">
              <img src="https://i.postimg.cc/SQ3RgNsQ/image.png" alt="Logo" style="width:45px;height:45px;border-radius:0;" />
            </th>
            <th>
              <input type="date" id="date-picker-rotated" />
            </th>
          </tr>
          <tr id="time-row-rotated">
            <th>LANE</th>
            <th id="overall-total-rotated">0ч 0м</th>
          </tr>
        </thead>
        <tbody id="table-body-rotated"></tbody>
      </table>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJcg8Ov4_-ijxTLQxJDjm2-IKCmI8l0AAsDo4sMeU-avSQp3F_E54gyB7f26z_KaE0FA/exec';
    const totalMinutes = 1440, groupInterval = 15, groupSize = 14;
    const letterRow = document.getElementById('letter-row'),
          timeRow = document.getElementById('time-row'),
          overallTotal = document.getElementById('overall-total'),
          tableBody = document.getElementById('table-body'),
          datePicker = document.getElementById('date-picker'),
          statusEl = document.getElementById('status'),
          rotateButton = document.getElementById('rotate-button');
          
    const letterRowRotated = document.getElementById('letter-row-rotated'),
          timeRowRotated = document.getElementById('time-row-rotated'),
          overallTotalRotated = document.getElementById('overall-total-rotated'),
          tableBodyRotated = document.getElementById('table-body-rotated'),
          datePickerRotated = document.getElementById('date-picker-rotated'),
          statusElRotated = document.getElementById('status-rotated');
          
    const allGroups = [], allDataCells = [];
    const allGroupsRotated = [], allDataCellsRotated = [];
    let isLoading = false;
    const fetchControllers = new Map();

    // Функция для поворота страницы
    function toggleRotation() {
      document.body.classList.toggle('rotated');
      rotateButton.textContent = document.body.classList.contains('rotated') ? '↻ Вернуть' : '↻ Повернуть';
      
      // Синхронизируем значения datepicker
      if (document.body.classList.contains('rotated')) {
        datePickerRotated.value = datePicker.value;
      } else {
        datePicker.value = datePickerRotated.value;
      }
    }

    // Добавляем обработчик события для кнопки поворота
    rotateButton.addEventListener('click', toggleRotation);

    function formatMinutes(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${h}ч ${m}м`;
    }

    function toggleGroup(idxs, isRotated = false) {
      const timeRowEl = isRotated ? timeRowRotated : timeRow;
      const letterRowEl = isRotated ? letterRowRotated : letterRow;
      const tableBodyEl = isRotated ? tableBodyRotated : tableBody;
      
      idxs.forEach(i => {
        [timeRowEl, letterRowEl].forEach(row => {
          if (row.children[i+2]) row.children[i+2].classList.toggle('hidden-column');
        });
        tableBodyEl.querySelectorAll('tr').forEach(tr => {
          if (tr.children[i+2]) tr.children[i+2].classList.toggle('hidden-column');
        });
      });
    }

    function areAllHidden(isRotated = false) {
      const groups = isRotated ? allGroupsRotated : allGroups;
      const timeRowEl = isRotated ? timeRowRotated : timeRow;
      
      return groups.every(g => {
        const el = timeRowEl.children[g[0]+2];
        return el && el.classList.contains('hidden-column');
      });
    }

    function toggleAll(forceHide=null, isRotated=false) {
      const groups = isRotated ? allGroupsRotated : allGroups;
      const timeRowEl = isRotated ? timeRowRotated : timeRow;
      
      const shouldHide = forceHide !== null ? forceHide : !areAllHidden(isRotated);
      groups.forEach(g => {
        const el = timeRowEl.children[g[0]+2];
        if (el) {
          const hidden = el.classList.contains('hidden-column');
          if (hidden !== shouldHide) toggleGroup(g, isRotated);
        }
      });
      
      const selector = isRotated ? '#main-table-rotated' : '#main-table';
      document.querySelectorAll(`${selector} .toggle-btn`).forEach(b => b.textContent = shouldHide ? '+' : '–');
    }

    function makeBtn(idxs, title, isRotated = false) {
      const btn = document.createElement('div');
      btn.className = 'toggle-btn';
      btn.title = title;
      btn.textContent = '+';
      let last = 0;
      btn.onclick = () => {
        const now = Date.now();
        if (now - last < 300) toggleAll(!areAllHidden(isRotated), isRotated);
        else {
          toggleGroup(idxs, isRotated);
          const timeRowEl = isRotated ? timeRowRotated : timeRow;
          btn.textContent = timeRowEl.children[idxs[0]+2].classList.contains('hidden-column') ? '+' : '–';
        }
        last = now;
      };
      return btn;
    }

    function buildHeaders(isRotated = false) {
      const fragL = document.createDocumentFragment(), fragT = document.createDocumentFragment();
      const groups = isRotated ? allGroupsRotated : allGroups;
      
      for (let i = 1; i <= totalMinutes; i++) {
        const thL = document.createElement('th'); 
        fragL.appendChild(thL);
        const h = Math.floor((i - 1) / 60), m = (i - 1) % 60;
        const thT = document.createElement('th');
        thT.innerHTML = `<div class="hour">${String(h).padStart(2,'0')}</div><div class="minute">${String(m).padStart(2,'0')}</div>`;
        fragT.appendChild(thT);
        if ((h*60 + m) % groupInterval === 0) {
          const start = (h*60 + m) === 0 ? 1 : (h*60 + m) + 1;
          const end = Math.min(start + groupSize - 1, totalMinutes - 1);
          const idxs = [];
          for (let j = start; j <= end; j++) idxs.push(j);
          if (idxs.length) {
            fragL.lastChild.appendChild(makeBtn(idxs, `Свернуть/развернуть ${formatMinutes(idxs[0])}–${formatMinutes(idxs[idxs.length-1])}`, isRotated));
            groups.push(idxs);
          }
        }
      }
      
      if (isRotated) {
        letterRowRotated.appendChild(fragL);
        timeRowRotated.appendChild(fragT);
      } else {
        letterRow.appendChild(fragL);
        timeRow.appendChild(fragT);
      }
    }

    function buildBody(isRotated = false) {
      const frag = document.createDocumentFragment();
      const dataCells = isRotated ? allDataCellsRotated : allDataCells;
      
      for (let lane = 0; lane < 16; lane++) {
        const tr = document.createElement('tr');
        const thLane = document.createElement('th'); 
        thLane.textContent = lane + 1; 
        tr.appendChild(thLane);
        const thCount = document.createElement('th'); 
        tr.appendChild(thCount);
        const cells = [];
        for (let i = 0; i < totalMinutes; i++) {
          const td = document.createElement('td');
          tr.appendChild(td);
          cells.push(td);
        }
        frag.appendChild(tr);
        dataCells.push({ header: thCount, cells });
      }
      
      if (isRotated) {
        tableBodyRotated.appendChild(frag);
      } else {
        tableBody.appendChild(frag);
      }
    }

    function clearRows(isRotated = false) {
      fetchControllers.forEach(controller => controller.abort());
      fetchControllers.clear();
      
      if (isRotated) {
        overallTotalRotated.textContent = '0ч 0м';
        allDataCellsRotated.forEach(r => {
          r.header.textContent = '';
          r.cells.forEach(c => {
            c.classList.remove('active-cell');
            c.textContent = '';
            c.style.color = '';
          });
        });
      } else {
        overallTotal.textContent = '0ч 0м';
        allDataCells.forEach(r => {
          r.header.textContent = '';
          r.cells.forEach(c => {
            c.classList.remove('active-cell');
            c.textContent = '';
            c.style.color = '';
          });
        });
      }
    }

    function setStatus(message, isError = false, isRotated = false) {
      if (isRotated) {
        statusElRotated.textContent = message;
        if (isError) statusElRotated.classList.add('error'); 
        else statusElRotated.classList.remove('error');
      } else {
        statusEl.textContent = message;
        if (isError) statusEl.classList.add('error'); 
        else statusEl.classList.remove('error');
      }
    }

    async function loadLaneData(idx, selectedDate) {
      const controller = new AbortController();
      fetchControllers.set(idx, controller);
      try {
        const url = `${SCRIPT_URL}?action=getData&index=${idx}&date=${selectedDate}&t=${Date.now()}`;
        const response = await fetch(url, { signal: controller.signal });
        if (!response.ok) throw new Error(`Ошибка HTTP: ${response.status}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        return data;
      } finally { fetchControllers.delete(idx); }
    }

    function updateUIWithData(data, idx, sumAll, isRotated = false) {
      const dataCells = isRotated ? allDataCellsRotated : allDataCells;
      const overallTotalEl = isRotated ? overallTotalRotated : overallTotal;
      
      const row = dataCells[idx];
      let sum = 0;
      row.cells.forEach((cell, i) => {
        const time = `${String(Math.floor(i/60)).padStart(2,'0')}:${String(i%60).padStart(2,'0')}`;
        cell.classList.remove('active-cell');
        if (data.c && data.c.includes(time)) { cell.classList.add('active-cell'); cell.textContent = '🎳'; sum++; }
        else if (data.b && data.b.includes(time)) { cell.textContent = ''; cell.style.color = 'black'; }
        else { cell.textContent = '⚡︎'; cell.style.color = '#dc143c'; }
      });
      row.header.textContent = formatMinutes(sum);
      sumAll.value += sum;
      
      if (isRotated) {
        overallTotalRotated.textContent = formatMinutes(sumAll.value);
      } else {
        overallTotal.textContent = formatMinutes(sumAll.value);
      }
    }

    async function loadData(isRotated = false) {
      const selectedDate = isRotated ? datePickerRotated.value : datePicker.value;
      if (!selectedDate || isLoading) return;
      
      isLoading = true;
      clearRows(isRotated);
      setStatus('Загрузка данных...', false, isRotated);
      
      let done = 0;
      const sumAll = { value: 0 };
      const errors = [];
      const promises = [];
      
      try {
        for (let idx = 0; idx < (isRotated ? allDataCellsRotated.length : allDataCells.length); idx++) {
          promises.push(
            loadLaneData(idx, selectedDate)
              .then(data => {
                updateUIWithData(data, idx, sumAll, isRotated);
                done++;
                setStatus(`Загружено ${done} из 16 дорожек...`, false, isRotated);
              })
              .catch(err => { 
                console.error(`Ошибка дорожки ${idx+1}:`, err); 
                errors.push(`Дорожка ${idx+1}: ${err.message}`); 
                done++; 
              })
          );
        }
        
        await Promise.allSettled(promises);
        
        if (errors.length > 0) {
          setStatus(`Загрузка завершена с ошибками: ${errors.join('; ')}`, true, isRotated);
        } else {
          setStatus(`Данные за ${selectedDate} успешно загружены. Всего: ${formatMinutes(sumAll.value)}`, false, isRotated);
        }
      } catch (error) { 
        console.error('Общая ошибка:', error); 
        setStatus(`Ошибка загрузки: ${error.message}`, true, isRotated); 
      } finally { 
        isLoading = false; 
        
        // Синхронизируем данные между обычным и повернутым режимом
        if (!isRotated) {
          datePickerRotated.value = selectedDate;
          overallTotalRotated.textContent = overallTotal.textContent;
        } else {
          datePicker.value = selectedDate;
          overallTotal.textContent = overallTotalRotated.textContent;
        }
      }
    }

    function init() {
      // Инициализация обычного режима
      buildHeaders(false);
      buildBody(false);
      
      // Инициализация повернутого режима
      buildHeaders(true);
      buildBody(true);
      
      // Обработчики событий для обычного режима
      datePicker.addEventListener('change', () => loadData(false));
      document.getElementById('logo-wrapper').addEventListener('click', () => { datePicker.click(); });
      
      // Обработчики событий для повернутого режима
      datePickerRotated.addEventListener('change', () => loadData(true));
      document.getElementById('logo-wrapper-rotated').addEventListener('click', () => { datePickerRotated.click(); });
      
      // Общие обработчики событий
      document.addEventListener('mouseover', function(e) {
        if (e.target.tagName === 'TD') {
          const td = e.target;
          const tableId = td.closest('table').id;
          const isRotated = tableId === 'main-table-rotated';
          
          const ci = td.cellIndex;
          const row = td.parentElement;
          
          const selector = isRotated ? '#main-table-rotated' : '#main-table';
          
          row.querySelectorAll('td').forEach(cell => cell.classList.add('hover-row'));
          document.querySelectorAll(`${selector} tbody tr`).forEach(r => { 
            const c = r.children[ci]; 
            if (c) c.classList.add('hover-col'); 
          });
          
          const th = document.querySelector(`${selector} thead tr:first-child th:nth-child(${ci+1})`);
          if (th) th.classList.add('hover-col');
        }
      });
      
      document.addEventListener('mouseout', function(e) {
        if (e.target.tagName === 'TD') {
          document.querySelectorAll('.hover-row, .hover-col').forEach(el => {
            el.classList.remove('hover-row', 'hover-col');
          });
        }
      });
      
      // Установка текущей даты
      const t = new Date();
      const iso = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
      datePicker.value = iso;
      datePickerRotated.value = iso;
      
      // Сворачиваем все группы
      setTimeout(() => {
        toggleAll(true, false);
        toggleAll(true, true);
      }, 100);
      
      // Загрузка данных
      setTimeout(() => loadData(false), 500);
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>